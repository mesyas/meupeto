<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Panel Financiero</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Metadatos PWA -->
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1pIFBhbmVsIEZpbmFuY2llcm8iLAogICJzaG9ydF9uYW1lIjogIkZpbmFuemFzIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiM2NjdlZWEiLAogICJ0aGVtZV9jb2xvciI6ICIjNjY3ZWVhIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFIZ0FBQUJZQ0FZQUFBQmxRSlUyQUFBQUFYTlNSMElBcnM0YzZRQUFJQUJKUkVGVWVKenQyLzdQd0FBQUFBQkpSVTVFcmtKZ2dnPT0iLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .data-management {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .install-button {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .summary-card .amount {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .income .amount { color: #10b981; }
        .expenses .amount { color: #ef4444; }
        .savings .amount { color: #3b82f6; }
        .balance .amount { color: #8b5cf6; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row > * {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
            flex: 1;
        }

        .btn-add {
            background: linear-gradient(135deg, #10b981, #34d399);
        }

        .btn-withdraw {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
        }

        .btn-export {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
        }

        .btn-import {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
        }

        .piggy-banks {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .piggy-bank {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .piggy-bank:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

        .piggy-bank::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .piggy-bank h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.3rem;
        }

        .piggy-bank h3 .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .piggy-bank h3 .delete-btn:hover {
            background: #dc2626;
        }

        .piggy-bank .amount {
            font-size: 1.8rem;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 15px;
            text-align: center;
        }

        .progress-bar {
            background: #e1e5e9;
            border-radius: 10px;
            height: 12px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #10b981, #34d399);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .piggy-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
            flex: 1;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: opacity 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-small:hover {
            opacity: 0.9;
        }

        .transactions {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
            transition: background 0.2s ease;
        }

        .transaction:hover {
            background: rgba(103, 126, 234, 0.05);
        }

        .transaction:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-description {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .transaction-category {
            font-size: 0.8rem;
            color: #666;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .transaction-amount.income {
            color: #10b981;
        }

        .transaction-amount.expense {
            color: #ef4444;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 10px;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close:hover {
            color: #333;
        }

        .modal-title {
            margin-bottom: 20px;
            color: #333;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .empty-state i {
            font-size: 3rem;
            color: #a0aec0;
            margin-bottom: 15px;
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(200%);
            transition: transform 0.3s ease;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.show {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                min-width: auto;
                height: 350px;
            }

            .piggy-banks {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .data-management {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 280px;
            }
        }

        .emoji {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .piggy-icon {
            font-size: 1.8rem;
            margin-right: 10px;
            color: #f59e0b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Mi Panel Financiero</h1>
            <p>Gestiona tus finanzas de manera inteligente</p>
            <div class="data-management">
                <button class="btn btn-export" onclick="exportData()"><i class="fas fa-file-export"></i> Exportar Datos</button>
                <button class="btn btn-import" onclick="document.getElementById('fileInput').click()"><i class="fas fa-file-import"></i> Importar Datos</button>
                <input type="file" id="fileInput" accept=".json" onchange="importData(event)" style="display: none;">
            </div>
            
            <!-- Botón para instalar la PWA -->
            <button id="installButton" class="install-button" style="display: none;">
                <i class="fas fa-download"></i> Instalar App
            </button>
            
            <div id="appInfo" style="margin-top: 15px; color: white; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> Los datos se guardan automáticamente en tu dispositivo
            </div>
        </div>

        <div class="summary-cards">
            <div class="summary-card income">
                <h3><i class="fas fa-arrow-up"></i> Total Ingresos</h3>
                <div class="amount" id="totalIncome">€0.00</div>
            </div>
            <div class="summary-card expenses">
                <h3><i class="fas fa-arrow-down"></i> Total Gastos</h3>
                <div class="amount" id="totalExpenses">€0.00</div>
            </div>
            <div class="summary-card savings">
                <h3><i class="fas fa-piggy-bank"></i> Total Ahorros</h3>
                <div class="amount" id="totalSavings">€0.00</div>
            </div>
            <div class="summary-card balance">
                <h3><i class="fas fa-balance-scale"></i> Balance</h3>
                <div class="amount" id="totalBalance">€0.00</div>
            </div>
        </div>

        <!-- Sección de Gráficas -->
        <div class="charts-section">
            <div class="chart-container">
                <h3><i class="fas fa-chart-bar"></i> Ingresos vs Gastos</h3>
                <div class="chart-wrapper">
                    <canvas id="incomeExpenseChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h3><i class="fas fa-chart-pie"></i> Distribución de Gastos</h3>
                <div class="chart-wrapper">
                    <canvas id="expenseDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="section">
                <h2><i class="fas fa-money-bill-wave"></i> Registrar Transacción</h2>
                <form id="transactionForm">
                    <div class="form-row">
                        <div>
                            <label><i class="fas fa-exchange-alt"></i> Tipo</label>
                            <select id="transactionType">
                                <option value="income">Ingreso</option>
                                <option value="expense">Gasto</option>
                            </select>
                        </div>
                        <div>
                            <label><i class="fas fa-euro-sign"></i> Cantidad</label>
                            <input type="number" id="transactionAmount" step="0.01" placeholder="0.00" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-comment"></i> Descripción</label>
                        <input type="text" id="transactionDescription" placeholder="Ej: Salario, Compra supermercado..." required>
                    </div>

                    <button type="submit" class="btn"><i class="fas fa-plus-circle"></i> Agregar Transacción</button>
                </form>
            </div>

            <div class="section">
                <h2><i class="fas fa-history"></i> Historial de Transacciones</h2>
                <div class="transactions" id="transactionsList">
                    <div class="empty-state">
                        <i class="fas fa-file-invoice"></i>
                        <p>No hay transacciones registradas</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2><i class="fas fa-piggy-bank"></i> Crear Nueva Hucha</h2>
            <form id="piggyBankForm">
                <div class="form-row">
                    <div>
                        <label><i class="fas fa-signature"></i> Nombre de la Hucha</label>
                        <input type="text" id="piggyName" placeholder="Ej: Vacaciones, Coche nuevo..." required>
                    </div>
                    <div>
                        <label><i class="fas fa-bullseye"></i> Meta de Ahorro</label>
                        <input type="number" id="piggyGoal" step="0.01" placeholder="0.00" required>
                    </div>
                </div>
                <button type="submit" class="btn"><i class="fas fa-plus-circle"></i> Crear Hucha</button>
            </form>
        </div>

        <div class="piggy-banks" id="piggyBanksList">
            <div class="empty-state">
                <i class="fas fa-piggy-bank"></i>
                <p>No tienes huchas creadas</p>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/retirar dinero de huchas -->
    <div id="piggyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePiggyModal()">&times;</span>
            <h2 class="modal-title" id="modalTitle">Gestionar Hucha</h2>
            <form id="piggyActionForm">
                <div class="form-group">
                    <label><i class="fas fa-euro-sign"></i> Cantidad</label>
                    <input type="number" id="piggyActionAmount" step="0.01" placeholder="0.00" required>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-add" onclick="piggyAction('add')"><i class="fas fa-plus"></i> Agregar</button>
                    <button type="button" class="btn btn-withdraw" onclick="piggyAction('withdraw')"><i class="fas fa-minus"></i> Retirar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notificación de guardado automático -->
    <div id="saveNotification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span>Datos guardados automáticamente</span>
    </div>

    <script>
        // Variables globales - Almacenamiento en localStorage
        let transactions = [];
        let piggyBanks = [];
        let currentPiggyIndex = -1;
        let incomeExpenseChart = null;
        let expenseDistributionChart = null;
        let deferredPrompt; // Para instalación PWA

        // Función para guardar datos en localStorage
        function saveData() {
            const data = {
                transactions: transactions,
                piggyBanks: piggyBanks,
                lastSave: new Date().toISOString()
            };
            
            localStorage.setItem('financialData', JSON.stringify(data));
            
            // Mostrar notificación de guardado
            showNotification('Datos guardados automáticamente');
        }

        // Función para cargar datos desde localStorage
        function loadData() {
            const savedData = localStorage.getItem('financialData');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    transactions = parsed.transactions || [];
                    piggyBanks = parsed.piggyBanks || [];
                    return true;
                } catch (e) {
                    console.error('Error al cargar datos:', e);
                    return false;
                }
            }
            return false;
        }

        // Mostrar notificación
        function showNotification(message) {
            const notification = document.getElementById('saveNotification');
            notification.querySelector('span').textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Exportar datos a archivo JSON
        function exportData() {
            const data = {
                transactions: transactions,
                piggyBanks: piggyBanks,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `finanzas-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Datos exportados correctamente');
        }

        // Importar datos desde archivo JSON
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.transactions && data.piggyBanks) {
                        if (confirm('¿Quieres reemplazar todos los datos actuales?')) {
                            transactions = data.transactions;
                            piggyBanks = data.piggyBanks;
                            
                            saveData();
                            renderTransactions();
                            renderPiggyBanks();
                            updateSummary();
                            updateCharts();
                            
                            showNotification('Datos importados correctamente');
                        }
                    } else {
                        alert('Archivo no válido');
                    }
                } catch (error) {
                    alert('Error al leer el archivo');
                }
            };
            reader.readAsText(file);
            
            // Limpiar el input
            event.target.value = '';
        }

        // Inicializar gráficas
        function initCharts() {
            // Gráfico de barras - Ingresos vs Gastos
            const ctx1 = document.getElementById('incomeExpenseChart').getContext('2d');
            incomeExpenseChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'Gastos'],
                    datasets: [{
                        label: 'Cantidad (€)',
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgba(16, 185, 129, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 10,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de dona - Distribución de gastos
            const ctx2 = document.getElementById('expenseDistributionChart').getContext('2d');
            expenseDistributionChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40',
                            '#FF6384',
                            '#C9CBCF'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Actualizar gráficas
        function updateCharts() {
            const income = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            // Actualizar gráfico de barras
            incomeExpenseChart.data.datasets[0].data = [income, expenses];
            incomeExpenseChart.update();

            // Actualizar gráfico de gastos por descripción
            const expenseTransactions = transactions.filter(t => t.type === 'expense');
            const expensesByDescription = {};
            
            expenseTransactions.forEach(t => {
                const key = t.description.length > 20 ? t.description.substring(0, 20) + '...' : t.description;
                expensesByDescription[key] = (expensesByDescription[key] || 0) + t.amount;
            });

            const labels = Object.keys(expensesByDescription);
            const data = Object.values(expensesByDescription);

            expenseDistributionChart.data.labels = labels;
            expenseDistributionChart.data.datasets[0].data = data;
            expenseDistributionChart.update();
        }

        // Formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        // Actualizar resumen
        function updateSummary() {
            const income = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const savings = piggyBanks.reduce((sum, p) => sum + p.current, 0);
            const balance = income - expenses;

            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpenses').textContent = formatCurrency(expenses);
            document.getElementById('totalSavings').textContent = formatCurrency(savings);
            document.getElementById('totalBalance').textContent = formatCurrency(balance);
        }

        // Agregar transacción
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDescription').value;
            
            // Validación
            if (!amount || amount <= 0) {
                alert('Por favor ingresa una cantidad válida');
                return;
            }
            
            if (!description || description.trim() === '') {
                alert('Por favor ingresa una descripción');
                return;
            }
            
            const transaction = {
                id: Date.now(),
                type: document.getElementById('transactionType').value,
                amount: amount,
                description: description.trim(),
                date: new Date().toLocaleDateString('es-ES')
            };

            transactions.unshift(transaction);
            saveData();
            renderTransactions();
            updateSummary();
            updateCharts();
            this.reset();
        });

        // Renderizar transacciones
        function renderTransactions() {
            const container = document.getElementById('transactionsList');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-invoice"></i>
                        <p>No hay transacciones registradas</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = transactions.map(t => `
                <div class="transaction">
                    <div class="transaction-info">
                        <div class="transaction-description">${t.description}</div>
                        <div class="transaction-category">${t.date}</div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="transaction-amount ${t.type}">
                            ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                        </div>
                        <button class="delete-btn" onclick="deleteTransaction(${t.id})"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // Eliminar transacción
        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            renderTransactions();
            updateSummary();
            updateCharts();
        }

        // Crear hucha
        document.getElementById('piggyBankForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('piggyName').value.trim();
            const goal = parseFloat(document.getElementById('piggyGoal').value);
            
            if (!name) {
                alert('Por favor ingresa un nombre para la hucha');
                return;
            }
            
            if (!goal || goal <= 0) {
                alert('Por favor ingresa una meta de ahorro válida');
                return;
            }
            
            const piggyBank = {
                id: Date.now(),
                name: name,
                goal: goal,
                current: 0
            };

            piggyBanks.push(piggyBank);
            saveData();
            renderPiggyBanks();
            updateSummary();
            this.reset();
        });

        // Renderizar huchas
        function renderPiggyBanks() {
            const container = document.getElementById('piggyBanksList');
            
            if (piggyBanks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-piggy-bank"></i>
                        <p>No tienes huchas creadas</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = piggyBanks.map((p, index) => {
                const progress = (p.current / p.goal) * 100;
                return `
                    <div class="piggy-bank">
                        <h3>
                            <i class="fas fa-piggy-bank piggy-icon"></i> ${p.name}
                            <button class="delete-btn" onclick="deletePiggyBank(${index})"><i class="fas fa-trash-alt"></i></button>
                        </h3>
                        <div class="amount">${formatCurrency(p.current)}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                        <div class="progress-text">
                            ${progress.toFixed(1)}% de ${formatCurrency(p.goal)}
                        </div>
                        <div class="piggy-actions">
                            <button class="btn-small btn-add" onclick="openPiggyModal(${index}, 'add')">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                            <button class="btn-small btn-withdraw" onclick="openPiggyModal(${index}, 'withdraw')">
                                <i class="fas fa-minus"></i> Retirar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Abrir modal de hucha
        function openPiggyModal(index, action) {
            currentPiggyIndex = index;
            document.getElementById('modalTitle').textContent = `Gestionar: ${piggyBanks[index].name}`;
            document.getElementById('piggyModal').style.display = 'block';
        }

        // Cerrar modal de hucha
        function closePiggyModal() {
            document.getElementById('piggyModal').style.display = 'none';
            document.getElementById('piggyActionAmount').value = '';
        }

        // Acción en hucha (agregar/retirar)
        function piggyAction(action) {
            const amount = parseFloat(document.getElementById('piggyActionAmount').value);
            if (!amount || amount <= 0) {
                alert('Por favor ingresa una cantidad válida');
                return;
            }

            const piggy = piggyBanks[currentPiggyIndex];
            
            if (action === 'add') {
                // Registrar como gasto (dinero que sale de disponible)
                const transaction = {
                    id: Date.now(),
                    type: 'expense',
                    amount: amount,
                    description: `Ahorro: ${piggy.name}`,
                    date: new Date().toLocaleDateString('es-ES')
                };
                transactions.unshift(transaction);
                
                piggy.current += amount;
            } else if (action === 'withdraw') {
                if (amount > piggy.current) {
                    alert('No puedes retirar más dinero del que tienes en la hucha');
                    return;
                }
                
                // Registrar como ingreso (dinero que vuelve a disponible)
                const transaction = {
                    id: Date.now(),
                    type: 'income',
                    amount: amount,
                    description: `Retiro de ahorro: ${piggy.name}`,
                    date: new Date().toLocaleDateString('es-ES')
                };
                transactions.unshift(transaction);
                
                piggy.current -= amount;
            }

            saveData();
            renderTransactions();
            renderPiggyBanks();
            updateSummary();
            updateCharts();
            closePiggyModal();
        }

        // Eliminar hucha
        function deletePiggyBank(index) {
            if (confirm('¿Estás seguro de que quieres eliminar esta hucha?')) {
                piggyBanks.splice(index, 1);
                saveData();
                renderPiggyBanks();
                updateSummary();
            }
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('piggyModal');
            if (event.target === modal) {
                closePiggyModal();
            }
        }

        // PWA: Instalación de la aplicación
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir que el mini-infobar aparezca en móviles
            e.preventDefault();
            // Guardar evento para activarlo más tarde
            deferredPrompt = e;
            // Mostrar botón de instalación
            const installButton = document.getElementById('installButton');
            installButton.style.display = 'flex';
            
            installButton.addEventListener('click', async () => {
                // Mostrar el prompt de instalación
                deferredPrompt.prompt();
                // Esperar a que el usuario responda
                const { outcome } = await deferredPrompt.userChoice;
                // Limpiar evento guardado
                deferredPrompt = null;
                // Ocultar botón de instalación
                installButton.style.display = 'none';
            });
        });

        // Inicialización
        window.addEventListener('DOMContentLoaded', () => {
            // Cargar datos guardados
            const dataLoaded = loadData();
            
            initCharts();
            renderTransactions();
            renderPiggyBanks();
            updateSummary();
            updateCharts();
            
            if (dataLoaded) {
                showNotification('Datos cargados correctamente');
            }
        });
    </script>
</body>
</html>